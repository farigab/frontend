<p-toast />

<div class="integrated-container">

  <div class="import-container">
    <div class="page-header">
      <div class="page-header-content">
        <h1 class="page-title">Good to see you again{{ user() ? ', ' + (user()?.name || user()?.login) : '' }}!</h1>
      </div>
    </div>

    <!-- PrimeNG Stepper -->
    <p-stepper [(value)]="activeStep" [linear]="true">

      <p-step-list>
        <p-step [value]="1" class="step-header">
          <ng-template #content let-value="value">
            <span class="step-circle" [class.active]="value <= activeStep">
              <i class="pi pi-github"></i>
              Connect
            </span>
          </ng-template>
        </p-step>

        <p-step [value]="2" class="step-header">
          <ng-template #content let-value="value">
            <span class="step-circle" [class.active]="value <= activeStep">
              <i class="pi pi-folder"></i>
              Repositories
            </span>
          </ng-template>
        </p-step>

        <p-step [value]="3" class="step-header">
          <ng-template #content let-value="value">
            <span class="step-circle" [class.active]="value <= activeStep">
              <i class="pi pi-calendar"></i>
              Time Period
            </span>
          </ng-template>
        </p-step>

        <p-step [value]="4" class="step-header">
          <ng-template #content let-value="value">
            <span class="step-circle" [class.active]="value <= activeStep">
              <i class="pi pi-sparkles"></i>
              AI Analysis
            </span>
          </ng-template>
        </p-step>
      </p-step-list>

      <p-step-panels>

        <!-- Step 1: Token Input -->
        <p-step-panel [value]="1">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step-content">
              <h2 class="section-title">Connect GitHub Account</h2>
              <p class="subtitle">Enter your Personal Access Token to get started</p>

              <div class="form-row">
                <label for="token-input">Personal Access Token</label>
                <input pInputText id="token-input" type="password" [ngModel]="token()"
                  (ngModelChange)="token.set($event)" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                  aria-describedby="token-help" />
                <small id="token-help" class="help-text">
                  Create a token at
                  <a href="https://github.com/settings/tokens/new?scopes=repo,read:user&description=farigab-bragdoc"
                    target="_blank" rel="noopener noreferrer">
                    GitHub Settings
                  </a>
                  with repo scope
                </small>
              </div>

              <div class="step-actions">
                <p-button label="Connect" icon="pi pi-github" (onClick)="saveToken()" [loading]="loading().repos"
                  [disabled]="!token()" />
              </div>
            </div>
          </ng-template>
        </p-step-panel>

        <!-- Step 2: Repository Selection -->
        <p-step-panel [value]="2">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step-content">
              <div class="card-header">
                <h2 class="section-title">Select Repositories</h2>
                <div class="repo-actions">
                  <button type="button" class="link-button" (click)="selectAll()">Select All</button>
                  <button type="button" class="link-button" (click)="clearSelection()">Clear</button>
                </div>
              </div>

              <p class="subtitle">
                @if (selectedCount() > 0) {
                {{ selectedCount() }} {{ selectedCount() === 1 ? 'repository' : 'repositories' }} selected
                } @else {
                All repositories will be included
                }
              </p>

              <div class="repo-grid" role="list">
                @for (repo of repositories(); track repo) {
                <div class="repo-card" role="listitem">
                  <label class="repo-checkbox">
                    <input type="checkbox" [checked]="selectedRepos().has(repo)" (change)="toggleSelection(repo)"
                      [attr.aria-label]="'Select ' + repo" />
                    <span class="repo-name">{{ repo }}</span>
                  </label>
                </div>
                }
              </div>

              <div class="step-actions">
                <p-button label="Back" severity="secondary" [outlined]="true" (onClick)="clearToken()" />
                <p-button label="Continue" (onClick)="activateCallback(3)" />
              </div>
            </div>
          </ng-template>
        </p-step-panel>

        <p-step-panel [value]="3">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step-content">
              <h2 class="section-title">What time period?</h2>
              <p class="subtitle">Choose the time range for your report</p>

              <div class="preset-buttons" role="list">
                @for (opt of presetOptions; track opt.value) {
                <button type="button" role="listitem" class="preset-button"
                  [class.active]="selectedPreset() === opt.value" [attr.aria-pressed]="selectedPreset() === opt.value"
                  (click)="selectPreset(opt.value)">
                  {{ opt.label }}
                </button>
                }
              </div>


              <div class="step-actions">
                <p-button label="Back" severity="secondary" [outlined]="true" (onClick)="activateCallback(2)" />
                <p-button label="Continue" (onClick)="activateCallback(4)" [disabled]="!hasDateRange()" />
              </div>
            </div>
          </ng-template>
        </p-step-panel>


        <!-- Step 4: AI Prompt & Analysis -->
        <p-step-panel [value]="4">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step-content">
              <h2 class="section-title">AI Analysis</h2>
              <p class="subtitle">Customize the prompt for automated analysis</p>

              <div class="form-row ai-prompt">
                <label for="ai-prompt">AI Prompt</label>
                <textarea pInputTextarea id="ai-prompt" rows="6" [ngModel]="customPrompt()"
                  (ngModelChange)="customPrompt.set($event)" placeholder="Write the prompt for the AI..."
                  [attr.maxlength]="maxPromptLength"
                  aria-describedby="ai-prompt-help ai-prompt-examples ai-prompt-count"
                  aria-label="AI Prompt"></textarea>

                <div id="ai-prompt-examples" class="ai-examples" aria-hidden="false">
                  <strong>Examples</strong>
                  <ul>
                    <li>Summarize the most important commits in this repository over the last 30 days.</li>
                    <li>List the top contributors and explain the impact of their changes.</li>
                    <li>Detect refactoring patterns and technical debt hotspots.</li>
                  </ul>
                </div>

                <div class="ai-prompt-footer">
                  <small id="ai-prompt-help" class="help-text">Use clear instructions and examples for better
                    results</small>
                  <small id="ai-prompt-count" class="help-text" aria-live="polite">{{ promptLength() }} / {{
                    maxPromptLength }}</small>
                </div>
              </div>

              <div class="step-actions">
                <p-button label="Back" severity="secondary" [outlined]="true" (onClick)="activateCallback(3)" />
                <p-button label="AI Analysis" icon="pi pi-robot" (onClick)="analyzeAI()" [disabled]="!customPrompt()" />
              </div>
            </div>
          </ng-template>
        </p-step-panel>

      </p-step-panels>
    </p-stepper>
  </div>
</div>
